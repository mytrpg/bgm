<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATIDA BGM SYNC - Debug Mode</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; text-align: center; }
        #player-wrapper { width: 10px; height: 10px; overflow: hidden; opacity: 0.01; position: absolute; top: -100px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 6px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #3700b3; border: none; font-weight: bold; }
        .host-only { display: none; }
        #current-title { color: #03dac6; font-weight: bold; font-size: 1.1rem; }
        #log-area { font-size: 0.7rem; color: #888; background: #000; padding: 10px; border-radius: 5px; height: 120px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; text-align: left; }
        .playlist-item { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="audio-unlock" onclick="startSession()">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ§</div>
        <b>í´ë¦­í•˜ì—¬ BGM ì„¸ì…˜ ì‹œì‘</b>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">(ì†Œë¦¬ ê¶Œí•œ íšë“ ë° í”Œë ˆì´ì–´ í™œì„±í™”)</p>
    </div>

    <div class="container">
        <div class="card">
            <h2 style="color: var(--primary); margin: 0 0 15px 0; font-size: 1.1rem;">MATIDA SYNC <span id="room-id" style="font-size: 0.7rem; color: #666;"></span></h2>
            <div id="player-wrapper"><div id="player"></div></div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 0.8rem; color: #888; margin: 0;">í˜„ì¬ ì¬ìƒ ê³¡</p>
                <div id="current-title">ëŒ€ê¸° ì¤‘...</div>
            </div>
            <div id="host-controls" class="host-only" style="display: flex; gap: 5px;">
                <button onclick="sendControl('playing')" style="background:#1b5e20">ì¬ìƒ</button>
                <button onclick="sendControl('paused')" style="background:#e65100">ì¼ì‹œì •ì§€</button>
                <button onclick="sendControl('stopped')" style="background:#b71c1c">ì •ì§€</button>
            </div>
        </div>

        <div id="host-panel" class="host-only card">
            <h3 style="margin: 0 0 10px 0; font-size: 1rem;">GM ê´€ë¦¬ ë„êµ¬</h3>
            <input type="text" id="yt-url" placeholder="ìœ íŠœë¸Œ ì „ì²´ ì£¼ì†Œ ë³µì‚¬">
            <input type="text" id="custom-title" placeholder="ì œëª© (ì˜ˆ: [ì „íˆ¬] ë³´ìŠ¤ì „)">
            <label style="font-size: 0.8rem; cursor:pointer;"><input type="checkbox" id="is-loop"> í•œê³¡ ë°˜ë³µ ì„¤ì •</label>
            <button onclick="addToPlaylist()" style="background: #444;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>
            <div style="display: flex; gap: 5px; margin-top:5px;">
                <button onclick="savePlaylist()" style="background:#333; font-size: 0.7rem;">ğŸ’¾ ë¦¬ìŠ¤íŠ¸ ì €ì¥</button>
                <button onclick="document.getElementById('file-input').click()" style="background:#333; font-size: 0.7rem;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="resetData()" style="background:#b71c1c; font-size: 0.7rem;">ğŸ§¹ ë°© ì´ˆê¸°í™”</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size: 0.9rem;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë° ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="playlist-container"></div>
            <div id="log-area">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
            <button onclick="enableHostMode()" style="background:transparent; color:#444; font-size:0.6rem; border:none; margin-top:10px;">(ë¹„ìƒìš©) GM ê¶Œí•œ ê°•ì œ í™œì„±í™”</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // [í•¨ìˆ˜] í™”ë©´ ë¡œê·¸ ì¶œë ¥: ì‚¬ìš©ìì—ê²Œ í˜„ì¬ ì§„í–‰ ìƒí™©ì„ í…ìŠ¤íŠ¸ë¡œ ë³´ì—¬ì¤Œ
        function log(msg) {
            console.log(`[SYSTEM]: ${msg}`); // ë¸Œë¼ìš°ì € ì½˜ì†”ì— ê¸°ë¡
            const area = document.getElementById('log-area');
            area.innerHTML += `<div>> ${msg}</div>`;
            area.scrollTop = area.scrollHeight; // ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ê²Œ ìŠ¤í¬ë¡¤
        }

        // Firebase ì„¤ì • (ì‚¬ìš©ì ì œê³µ ì •ë³´)
        const firebaseConfig = {
            apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0",
            authDomain: "trpg-bgm-from.firebaseapp.com",
            databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "trpg-bgm-from",
            storageBucket: "trpg-bgm-from.firebasestorage.app",
            messagingSenderId: "731757785916",
            appId: "1:731757785916:web:f02ee6e3d03f5e91856439"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        log("Firebase ì—°ê²° ì—”ì§„ ê°€ë™");

        // [ë³€ìˆ˜ ì„¤ì •] ë°© ë²ˆí˜¸ì™€ í˜¸ìŠ¤íŠ¸ ì—¬ë¶€ë¥¼ ê²°ì •í•¨
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let isHost = urlParams.get('host') === 'true' || !roomId;

        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8); // ëœë¤ ë°© ìƒì„±
            window.history.replaceState({}, '', `?room=${roomId}&host=true`);
            isHost = true;
            log(`ìƒˆë¡œìš´ ë°© ìƒì„±: ${roomId}`);
        }
        document.getElementById('room-id').innerText = `ROOM: ${roomId}`;

        // [í•¨ìˆ˜] í˜¸ìŠ¤íŠ¸ UI í‘œì‹œ: GMì¸ ê²½ìš°ì—ë§Œ ê´€ë¦¬ ë„êµ¬ë¥¼ ë³´ì—¬ì¤Œ
        function applyHostUI() {
            console.log(`[AUTH]: í˜¸ìŠ¤íŠ¸ ì—¬ë¶€ ì²´í¬ -> ${isHost}`);
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
                log("GM ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ ë„êµ¬ë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.");
            }
        }

        // [í•¨ìˆ˜] GM ê¶Œí•œ ê°•ì œ í™œì„±í™”: ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ë™ìœ¼ë¡œ ê¶Œí•œ ë¶€ì—¬
        function enableHostMode() {
            log("GM ê¶Œí•œ ê°•ì œ í™œì„±í™”ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.");
            isHost = true;
            applyHostUI();
            render(); // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¬ìƒ ë²„íŠ¼ì„ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ì‹œ ê·¸ë¦¼
        }
        applyHostUI();

        // [í•¨ìˆ˜] ë°© ë°ì´í„° ì´ˆê¸°í™”: Firebaseì— ì €ì¥ëœ ê³¼ê±° ë°ì´í„°ë¥¼ ì‚­ì œí•¨
        function resetData() {
            console.log("[ACTION]: ë°ì´í„° ì´ˆê¸°í™” ì‹œë„");
            if(confirm("ë°©ì˜ ëª¨ë“  ì¬ìƒ ìƒíƒœë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                db.ref(`rooms/${roomId}/state`).remove();
                log("ğŸ§¹ Firebase ì„œë²„ ë°ì´í„° ì²­ì†Œ ì™„ë£Œ.");
                setTimeout(() => location.reload(), 500);
            }
        }

        // [ìœ íŠœë¸Œ API] í”Œë ˆì´ì–´ ì´ˆê¸° ì„¤ì •
        let player;
        let isPlayerReady = false;
        function onYouTubeIframeAPIReady() {
            console.log("[YOUTUBE]: IFrame API ë¡œë“œ ì™„ë£Œ, í”Œë ˆì´ì–´ ìƒì„± ì‹œì‘");
            player = new YT.Player('player', {
                height: '10', width: '10',
                playerVars: { 'autoplay': 1, 'controls': 0, 'playsinline': 1 },
                events: {
                    'onReady': () => { 
                        isPlayerReady = true; 
                        log("âœ… ìœ íŠœë¸Œ í”Œë ˆì´ì–´ ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ!"); 
                    },
                    'onError': (e) => { 
                        log(`âŒ ìœ íŠœë¸Œ ì—ëŸ¬ ë°œìƒ: ì½”ë“œ ${e.data}`);
                        console.error("[YOUTUBE ERROR]:", e);
                    }
                }
            });
        }

        // [í•¨ìˆ˜] ì„¸ì…˜ ì‹œì‘: ê¹Œë§Œ í™”ë©´ì„ í´ë¦­í–ˆì„ ë•Œ ì˜¤ë””ì˜¤ ì ê¸ˆì„ í•´ì œí•¨
        function startSession() {
            console.log("[ACTION]: ì„¸ì…˜ ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨");
            document.getElementById('audio-unlock').style.display = 'none';
            if (isPlayerReady) {
                player.playVideo(); // ì†Œë¦¬ ê¶Œí•œ íšë“ì„ ìœ„í•œ ì¬ìƒ
                setTimeout(() => { 
                    if(!isHost) player.pauseVideo(); // ê²ŒìŠ¤íŠ¸ëŠ” ê¶Œí•œ íšë“ í›„ ëŒ€ê¸°
                }, 200);
            }
        }

        // [ë°ì´í„° ë™ê¸°í™”] Firebase ì„œë²„ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª…ë ¹ì„ ë°›ì•„ ì‹¤í–‰í•¨
        let lastId = "";
        let lastStatus = "";
        db.ref(`rooms/${roomId}/state`).on('value', (snap) => {
            const data = snap.val();
            console.log("[SYNC]: ì„œë²„ë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹ ", data);
            
            if (!data) {
                document.getElementById('current-title').innerText = "ëŒ€ê¸° ì¤‘...";
                return;
            }

            const vid = data.videoId ? data.videoId.toString().trim() : "";
            
            // ê²€ë¬¸: 11ìë¦¬ê°€ ì•„ë‹ˆë©´ ì“°ë ˆê¸° ë°ì´í„°ë¡œ íŒë‹¨í•˜ê³  ë¬´ì‹œ
            if (vid.length !== 11) {
                console.warn(`[SYNC]: ë¶€ì ì ˆí•œ ì˜ìƒ ID(${vid}) ê°ì§€ë¨. ì‹¤í–‰ì„ ê±°ë¶€í•©ë‹ˆë‹¤.`);
                return;
            }

            document.getElementById('current-title').innerText = data.customTitle;

            if (isPlayerReady) {
                // 1. ì˜ìƒ ìì²´ê°€ ë°”ë€Œì—ˆì„ ë•Œ (ID ë¹„êµ)
                if (lastId !== vid) {
                    console.log(`[YOUTUBE]: ìƒˆ ì˜ìƒ ë¡œë“œ ì‹œì‘ -> ${vid}`);
                    player.loadVideoById(vid);
                    lastId = vid;
                    lastStatus = "playing";
                    log(`ğŸµ ê³¡ ë³€ê²½ë¨: ${data.customTitle}`);
                }
                // 2. ì¬ìƒ ìƒíƒœ(ë²„íŠ¼ ì¡°ì‘)ê°€ ë°”ë€Œì—ˆì„ ë•Œ
                if (lastStatus !== data.status) {
                    console.log(`[YOUTUBE]: ìƒíƒœ ë³€ê²½ ëª…ë ¹ ìˆ˜í–‰ -> ${data.status}`);
                    if (data.status === 'playing') player.playVideo();
                    else if (data.status === 'paused') player.pauseVideo();
                    else if (data.status === 'stopped') { player.pauseVideo(); player.seekTo(0); }
                    lastStatus = data.status;
                }
            }
        });

        // [í•¨ìˆ˜] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ê³¡ ì¶”ê°€: ì…ë ¥í•œ URLì—ì„œ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ì €ì¥
        let playlist = [];
        function addToPlaylist() {
            const url = document.getElementById('yt-url').value;
            console.log(`[ACTION]: ê³¡ ì¶”ê°€ ì‹œë„ -> URL: ${url}`);
            
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            const vid = (match && match[7].length == 11) ? match[7] : false;

            if (!vid) {
                console.error("[ACTION]: ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì£¼ì†Œì…ë‹ˆë‹¤.");
                alert("ìœ íŠœë¸Œ ì£¼ì†Œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            const title = document.getElementById('custom-title').value || "BGM " + (playlist.length + 1);
            playlist.push({
                videoId: vid,
                customTitle: title,
                isLoop: document.getElementById('is-loop').checked
            });
            log(`â• ëª©ë¡ì— ì¶”ê°€ë¨: ${title}`);
            render();
            document.getElementById('yt-url').value = "";
            document.getElementById('custom-title').value = "";
        }

        // [í•¨ìˆ˜] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í™”ë©´ ì¶œë ¥: ëª©ë¡ ë°ì´í„°ë¥¼ HTMLë¡œ ë³€í™˜í•¨
        function render() {
            console.log("[UI]: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.");
            document.getElementById('playlist-container').innerHTML = playlist.map((item, i) => `
                <div class="playlist-item">
                    <span>${item.customTitle} ${item.isLoop ? 'ğŸ”„' : ''}</span>
                    ${isHost ? `<button onclick="playTrack(${i})" style="width:50px; padding:3px; margin:0; font-size:0.7rem;">ì¬ìƒ</button>` : ''}
                </div>
            `).join('');
        }

        // [í•¨ìˆ˜] íŠ¹ì • íŠ¸ë™ ì¬ìƒ: ì„ íƒí•œ ê³¡ì˜ ë°ì´í„°ë¥¼ Firebase ì„œë²„ë¡œ ì „ì†¡
        function playTrack(i) {
            const track = playlist[i];
            console.log(`[ACTION]: íŠ¸ë™ ì¬ìƒ ëª…ë ¹ ì „ì†¡ -> ${track.customTitle}`);
            db.ref(`rooms/${roomId}/state`).set({ 
                ...track, 
                status: 'playing', 
                ts: Date.now() 
            });
        }

        // [í•¨ìˆ˜] ì¬ìƒ ì»¨íŠ¸ë¡¤ ì „ì†¡: ì¬ìƒ/ì¼ì‹œì •ì§€/ì •ì§€ ìƒíƒœë¥¼ ì„œë²„ë¡œ ì „ì†¡
        function sendControl(s) {
            console.log(`[ACTION]: ìƒíƒœ ì œì–´ ëª…ë ¹ ì „ì†¡ -> ${s}`);
            db.ref(`rooms/${roomId}/state/status`).set(s);
        }

        // [í•¨ìˆ˜] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥: í˜„ì¬ ëª©ë¡ì„ .json íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function savePlaylist() {
            console.log("[ACTION]: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥ ì‹œì‘");
            const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob); 
            a.download = `matida_bgm_${roomId}.json`; 
            a.click();
            log("ğŸ’¾ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
        }

        // [í•¨ìˆ˜] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°: .json íŒŒì¼ì„ ì½ì–´ ëª©ë¡ì— ë°˜ì˜
        function loadPlaylist(e) {
            console.log("[ACTION]: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ì‹œë„");
            const reader = new FileReader();
            reader.onload = (ev) => { 
                try { 
                    playlist = JSON.parse(ev.target.result); 
                    render(); 
                    log(`ğŸ“‚ íŒŒì¼ë¡œë¶€í„° ${playlist.length}ê°œì˜ ê³¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } catch(err) {
                    console.error("[FILE ERROR]:", err);
                    alert("ì˜¬ë°”ë¥¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
                } 
            };
            reader.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
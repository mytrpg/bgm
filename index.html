<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG BGM from Youtube</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00ffff; --grey: #333; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 650px; display: none; }
        
        /* ì…ì¥ í™”ë©´ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 340px; }
        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        /* ë ˆì´ì•„ì›ƒ */
        #players-container { width: 1px; height: 1px; overflow: hidden; position: absolute; opacity: 0; }
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .flex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h2 { color: var(--primary); margin: 0; font-size: 1rem; }
        h3 { color: var(--primary); margin: 0; font-size: 0.95rem; }
        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; margin: 4px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #3700b3; border: none; font-weight: bold; font-size: 0.85rem; }
        
        /* My Master Volume */
        .guest-master-vol { background: #333; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .vol-header { display: flex; justify-content: space-between; align-items: baseline; gap: 10px; }
        .vol-desc { font-size: 0.65rem; color: #888; margin: 0; }

        /* í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM ë¦¬ìŠ¤íŠ¸ (ê¸€ì í¬ê¸° ë³µêµ¬) */
        .active-track-item { background: #252525; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .active-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .active-title { font-weight: bold; color: var(--accent); font-size: 1rem; }
        .active-controls { display: flex; gap: 5px; width: 60%; align-items: center; }
        
        /* ë³¼ë¥¨ ë° ì¬ìƒ ë°” ìŠ¤íƒ€ì¼ */
        .slider-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; width: 100%; }
        .row-label { font-size: 0.7rem; color: #aaa; white-space: nowrap; }
        .vol-text { font-size: 0.75rem; min-width: 40px; color: var(--accent); text-decoration: underline; cursor: pointer; text-align: right; }
        
        /* ë³¼ë¥¨ ë°” ì»¬ëŸ¬ë§ ìœ ì§€ */
        input[type="range"] { -webkit-appearance: none; flex: 1; height: 6px; background: #444; border-radius: 3px; cursor: pointer; outline: none; }
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--accent); margin-top: -4px; box-shadow: 0 0 2px #000; }
        
        /* ë³¼ë¥¨ ë°” ìƒ‰ê¹”ì„ ì±„ìš°ê¸° ìœ„í•œ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ */
        .fill-cyan { background: linear-gradient(to right, var(--accent) 0%, var(--accent) var(--p), #444 var(--p)) !important; }

        .time-text { font-size: 0.65rem; color: #888; min-width: 80px; text-align: right; font-family: monospace; }

        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (ê¸°ëŠ¥ ë³µêµ¬) */
        .playlist-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; cursor: grab; }
        .item-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .btn-group { display: flex; gap: 4px; align-items: center; }
        .small-btn { padding: 4px 8px; font-size: 0.65rem; width: auto; min-width: 40px; }
        
        /* ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-loop-on { background: var(--primary) !important; color: #000; }
        .btn-loop-off { background: #555 !important; color: #ccc; }
        .btn-play-toggle { background: var(--accent) !important; color: #000; }
        .btn-stop-toggle { background: var(--primary) !important; color: #000; }
        
        .item-meta { font-size: 0.65rem; color: #777; margin-top: 6px; line-height: 1.4; display: flex; align-items: center; gap: 5px; }

        /* ë¡œê·¸ ë° ìœ ì € ëª©ë¡ */
        #log-area { font-size: 0.65rem; color: #888; background: #000; padding: 10px; border-radius: 5px; height: 100px; overflow-y: auto; border: 1px solid #333; }
        .user-tag { display: inline-block; padding: 2px 7px; border-radius: 12px; background: #333; margin-right: 4px; font-size: 0.7rem; border: 1px solid #444; }
        .user-tag.host { border-color: var(--primary); color: var(--primary); }

        /* ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 30000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 350px; border: 1px solid var(--accent); }
        .modal-desc { font-size: 0.8rem; color: #bbb; line-height: 1.6; margin: 15px 0; }
        
        .footer { text-align: center; font-size: 0.6rem; color: #444; margin-top: 30px; margin-bottom: 20px; }
        .host-only { display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--accent); font-size: 1rem; margin-bottom: 15px;">TRPG BGM from Youtube</h1>
            <input type="text" id="input-room-name" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="input-nickname" placeholder="ë‹‰ë„¤ì„">
            <button onclick="enterRoom('host')" style="background:var(--primary); color:#000;">ë°© ìƒì„± (í˜¸ìŠ¤íŠ¸)</button>
            <div id="guest-msg" style="display:none; margin-top:15px; font-size:0.8rem; color:#888;">
                ë§í¬ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì…ì¥í•˜ì„¸ìš”.
            </div>
        </div>
    </div>

    <div id="audio-unlock" onclick="unlockAudio()">
        <div style="font-size: 50px;">ğŸ§</div>
        <b>ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ í™œì„±í™”</b>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--accent);">BGM ì •ë³´ ìˆ˜ì •</h3>
            <input type="text" id="edit-title" placeholder="ê³¡ ì œëª©">
            <input type="text" id="edit-url" placeholder="ìœ íŠœë¸Œ URL">
            <div style="display:flex; gap:8px; margin-top:15px;">
                <button onclick="closeModal('edit-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button>
                <button onclick="saveEdit()" style="flex:1; background:var(--accent); color:#000;">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="vol-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--accent);">ë³¼ë¥¨ ì„¤ì •</h3>
            <p id="vol-modal-target" style="font-size:0.75rem; color:#888; margin:10px 0;"></p>
            <input type="number" id="vol-input-box" min="0" max="100">
            <div style="display:flex; gap:8px; margin-top:15px;">
                <button onclick="closeModal('vol-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button>
                <button onclick="saveVolumeFromModal()" style="flex:1; background:var(--accent); color:#000;">ì ìš©</button>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--primary);">ë°© ë°ì´í„° ì´ˆê¸°í™”</h3>
            <div class="modal-desc">
                ì´ ì‘ì—…ì€ ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:<br>
                - í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ëª¨ë“  BGM ì •ì§€ ë° ì œê±°<br>
                - í•˜ë‹¨ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ëª©ë¡ ì‚­ì œ<br>
                - ë°©ì˜ ì°Œêº¼ê¸° ë°ì´í„° ì™„ì „ ì²­ì†Œ<br><br>
                <b>ì£¼ì˜: ì ‘ì† ì¤‘ì¸ ë‹‰ë„¤ì„ê³¼ ê¶Œí•œì€ ìœ ì§€ë©ë‹ˆë‹¤.</b>
            </div>
            <div style="display:flex; gap:8px;">
                <button onclick="closeModal('reset-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button>
                <button onclick="executeSoftReset()" style="flex:1; background:#b71c1c; color:#fff;">ì´ˆê¸°í™” ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-container">
        <div class="guest-master-vol">
            <div class="vol-header">
                <span style="font-weight:bold; color:var(--accent); font-size:0.85rem;">My Master Volume</span>
                <p class="vol-desc">* ë‚˜ì—ê²Œë§Œ ë“¤ë¦¬ëŠ” ì „ì²´ ìŒëŸ‰ì…ë‹ˆë‹¤.</p>
                <span id="guest-vol-text" class="vol-text" title="í´ë¦­í•˜ì—¬ ë³¼ë¥¨ ì¡°ì ˆ" onclick="openVolModal('master')">100%</span>
            </div>
            <input type="range" id="guest-master-slider" min="0" max="100" value="100" oninput="changeMyMasterVolume(this.value)" class="fill-cyan" style="--p:100%">
        </div>

        <div class="card">
            <div class="flex-header">
                <h2>ROOM: <span id="room-display"></span></h2>
                <button onclick="copyInviteLink()" style="width:auto; padding:5px 10px; font-size:0.65rem; background:#444;">ë§í¬ ë³µì‚¬</button>
            </div>
            <div id="players-container"></div>
            <p style="margin: 15px 0 5px 0; font-size: 0.8rem; color: #666; font-weight: bold;">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM</p>
            <div id="active-tracks-ui"></div>
        </div>

        <div id="host-panel" class="host-only card">
            <div class="flex-header">
                <h3>ê³¡ ì¶”ê°€</h3>
                <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:0.75rem; cursor:pointer;"><input type="checkbox" id="is-loop" style="width:auto; margin:0;"> ë°˜ë³µ</label>
                    <button onclick="addToPlaylist()" style="background:var(--accent); color:#000; width:65px; padding:5px; font-size:0.75rem;">ì¶”ê°€</button>
                </div>
            </div>
            <input type="text" id="yt-url" placeholder="ìœ íŠœë¸Œ URL">
            <input type="text" id="custom-title" placeholder="í‘œì‹œ ì œëª©">
            <div style="display: flex; gap: 4px; margin-top:8px;">
                <button onclick="savePlaylist()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ’¾ ì €ì¥</button>
                <button onclick="document.getElementById('file-input').click()" style="flex:1; background:#333; font-size:0.7rem;">ğŸ“‚ ì—´ê¸°</button>
                <button onclick="openResetModal()" style="flex:1; background:#b71c1c; font-size:0.7rem;">ğŸ§¹ ì´ˆê¸°í™”</button>
            </div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3 id="playlist-header" style="margin-bottom:12px;">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
            <div id="playlist-container"></div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:10px; font-size: 0.85rem;">ì ‘ì†ì (<span id="user-count">0</span>)</h3>
            <div id="user-list-container"></div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:8px; font-size: 0.85rem;">ì‹œìŠ¤í…œ ë¡œê·¸</h3>
            <div id="log-area">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div class="footer">ë¬¸ì˜: Twitter @SIHAST</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0",
            authDomain: "trpg-bgm-from.firebaseapp.com",
            databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "trpg-bgm-from",
            storageBucket: "trpg-bgm-from.firebasestorage.app",
            messagingSenderId: "731757785916",
            appId: "1:731757785916:web:f02ee6e3d03f5e91856439"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = "", roomName = "", isHost = false, myNickname = "", myMasterVol = 100, playlist = [], players = {}, currentActiveData = {};

        // [ì ‘ì† ì´ˆê³¼ ë©”ì‹œì§€]
        db.ref(".info/connected").on("value", (snap) => {
            if (snap.val() === false) {
                // ì ‘ì†ì´ ëŠê¸´ ì§€ 10ì´ˆê°€ ì§€ë‚¬ëŠ”ë°ë„ ì—°ê²°ì´ ì•ˆ ë˜ë©´ ì•Œë¦¼ (ì´ˆê¸° ë¡œë”© ì‹œ 100ëª… ì´ˆê³¼ ëŒ€ì‘)
                setTimeout(() => {
                    if (!db.app.options) return; // ë¯¸ì´ˆê¸°í™” ìƒíƒœë©´ ë¬´ì‹œ
                    if (snap.val() === false && !document.getElementById('main-container').style.display) {
                        alert("í˜„ì¬ ì„œë²„ ì ‘ì†ìê°€ ë„ˆë¬´ ë§ì•„ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                }, 10000);
            }
        });

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const rId = params.get('room');
            if (rId) {
                roomId = rId;
                document.getElementById('guest-msg').style.display = 'block';
                if (params.get('h') === '1') {
                    isHost = true;
                    document.querySelector('button[onclick="enterRoom(\'host\')"]').innerText = "ê´€ë¦¬ì ì„¸ì…˜ ë³µêµ¬";
                } else {
                    document.querySelector('button[onclick="enterRoom(\'host\')"]').style.display = 'none';
                }
            }
        };

        async function enterRoom(role) {
            const nName = document.getElementById('input-nickname').value.trim();
            if (!nName) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myNickname = nName;

            if (!roomId) {
                isHost = true;
                roomName = document.getElementById('input-room-name').value.trim() || "TRPG SESSION";
                roomId = Math.random().toString(36).substring(2, 10);
                await db.ref(`rooms/${roomId}/roomName`).set(roomName);
            } else {
                const snap = await db.ref(`rooms/${roomId}`).once('value');
                if (!snap.exists()) return alert("ë§Œë£Œëœ ë°©ì…ë‹ˆë‹¤.");
                const emptySince = snap.val().emptySince;
                if (emptySince && Date.now() - emptySince > 300000) {
                    await db.ref(`rooms/${roomId}`).remove();
                    return alert("5ë¶„ ì´ìƒ ë¹„ì–´ìˆì–´ ë°© ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                roomName = snap.val().roomName || "TRPG SESSION";
            }

            if (isHost) {
                const newUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}&h=1`;
                window.history.replaceState({}, '', newUrl);
            }

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('audio-unlock').style.display = 'flex';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('room-display').innerText = roomName;
            
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
                document.getElementById('playlist-header').innerText = 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½)';
            }
            setupPresence(); initSync(); setInterval(updateAllProgress, 1000);
        }

        function copyInviteLink() {
            const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            navigator.clipboard.writeText(link).then(() => alert("ì´ˆëŒ€ ë§í¬ ë³µì‚¬ ì™„ë£Œ!"));
        }

        function setupPresence() {
            const usersRef = db.ref(`rooms/${roomId}/users`);
            const userRef = usersRef.push();
            userRef.onDisconnect().remove();
            usersRef.on('value', (snap) => {
                const users = snap.val() || {};
                const userArray = Object.values(users);
                if (userArray.length === 0) db.ref(`rooms/${roomId}/emptySince`).set(Date.now());
                else db.ref(`rooms/${roomId}/emptySince`).remove();
                document.getElementById('user-count').innerText = userArray.length;
                const container = document.getElementById('user-list-container');
                container.innerHTML = '';
                userArray.forEach(u => {
                    const tag = document.createElement('span');
                    tag.className = `user-tag ${u.isHost ? 'host' : ''}`;
                    tag.innerText = `${u.isHost ? 'ğŸ‘‘ ' : ''}${u.nickname}`;
                    container.appendChild(tag);
                });
            });
            userRef.set({ nickname: myNickname, isHost: isHost });
        }

        function unlockAudio() { document.getElementById('audio-unlock').style.display = 'none'; log(`ì„¸ì…˜ ì ‘ì†: ${myNickname}`); }

        // ë³¼ë¥¨ ëª¨ë‹¬
        let vt = null, vv = null, vi = null;
        function openVolModal(type, vid = null, index = null) {
            vt = type; vv = vid; vi = index;
            const cur = type === 'master' ? myMasterVol : (type === 'active' ? currentActiveData[vid].volume : playlist[index].volume);
            document.getElementById('vol-modal-target').innerText = `ëŒ€ìƒ: ${type === 'master' ? 'ë§ˆìŠ¤í„°' : (type === 'active' ? currentActiveData[vid].title : playlist[index].title)}`;
            document.getElementById('vol-input-box').value = cur;
            document.getElementById('vol-modal').style.display = 'flex';
        }
        function saveVolumeFromModal() {
            const val = Math.max(0, Math.min(100, parseInt(document.getElementById('vol-input-box').value) || 0));
            if (vt === 'master') changeMyMasterVolume(val);
            else if (vt === 'active') db.ref(`rooms/${roomId}/active/${vv}/volume`).set(val);
            else if (vt === 'playlist') { playlist[vi].volume = val; render(); }
            closeModal('vol-modal');
        }

        function changeMyMasterVolume(val) {
            myMasterVol = val;
            document.getElementById('guest-vol-text').innerText = `${val}%`;
            const slider = document.getElementById('guest-master-slider');
            slider.value = val;
            slider.style.setProperty('--p', val + '%');
            Object.keys(players).forEach(vid => applyCalculatedVolume(vid));
        }

        function applyCalculatedVolume(vid) {
            if (players[vid] && players[vid].setVolume) {
                const sVol = (currentActiveData[vid] && currentActiveData[vid].volume !== undefined) ? currentActiveData[vid].volume : 100;
                players[vid].setVolume((sVol * myMasterVol) / 100);
            }
        }

        // [í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM UI] ë³¼ë¥¨ ë°” ë° ë ˆì´ì•„ì›ƒ ë³µêµ¬
        function initSync() {
            db.ref(`rooms/${roomId}/active`).on('value', (snap) => {
                currentActiveData = snap.val() || {};
                const activeIds = Object.keys(currentActiveData);
                const uiContainer = document.getElementById('active-tracks-ui');
                uiContainer.innerHTML = activeIds.length === 0 ? '<p style="font-size: 0.75rem; color: #444;">ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ</p>' : '';

                activeIds.forEach(vid => {
                    const track = currentActiveData[vid];
                    const div = document.createElement('div');
                    div.className = 'active-track-item';
                    const s = track.status, l = track.loop, vol = track.volume || 100;
                    
                    div.innerHTML = `
                        <div class="active-header">
                            <span class="active-title">${track.title}</span>
                            <div class="active-controls" style="display:${isHost ? 'flex' : 'none'};">
                                <button class="small-btn ${l ? 'btn-loop-on' : 'btn-loop-off'}" style="flex:0.6;" onclick="db.ref('rooms/${roomId}/active/${vid}/loop').set(${!l})">${l ? 'ë°˜ë³µ' : '1íšŒ'}</button>
                                <button class="btn-status ${s==='playing'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('playing')">â–¶</button>
                                <button class="btn-status ${s==='paused'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('paused')">II</button>
                                <button class="btn-status ${s==='stopped'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('stopped')">â– </button>
                                <button class="small-btn" style="background:#444;" onclick="db.ref('rooms/${roomId}/active/${vid}').remove()">ì§€ìš°ê¸°</button>
                            </div>
                        </div>
                        <div class="slider-row">
                            <span class="row-label">ì¬ìƒ ë³¼ë¥¨</span>
                            <span class="vol-text" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •" onclick="${isHost?`openVolModal('active', '${vid}')`:''}">${vol}%</span>
                            <input type="range" min="0" max="100" value="${vol}" disabled class="fill-cyan" style="--p:${vol}%; flex:0.3; min-width:60px;">
                            <div style="width:15px;"></div>
                            <input type="range" class="progress-bar fill-cyan" id="bar-${vid}" value="0" min="0" step="1" oninput="if(players['${vid}'])players['${vid}'].seekTo(this.value)" ${isHost?'':'disabled'} style="--p:0%">
                            <span class="time-text" id="time-${vid}">0:00 / 0:00</span>
                        </div>
                    `;
                    uiContainer.appendChild(div);

                    if (!players[vid]) {
                        createPlayer(vid, track.loop, track.title, s);
                    } else if (players[vid].getPlayerState) {
                        if (s === 'playing') players[vid].playVideo();
                        else if (s === 'paused') players[vid].pauseVideo();
                        else if (s === 'stopped') { players[vid].pauseVideo(); players[vid].seekTo(0); }
                        applyCalculatedVolume(vid);
                    }
                });
                Object.keys(players).forEach(vid => { if (!currentActiveData[vid]) { players[vid].stopVideo(); players[vid].destroy(); delete players[vid]; } });
                render();
            });
        }

        function createPlayer(vid, loop, title, initialStatus) {
            const div = document.createElement('div'); div.id = `player-${vid}`;
            document.getElementById('players-container').appendChild(div);
            players[vid] = new YT.Player(`player-${vid}`, {
                height: '1', width: '1', videoId: vid,
                playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1 },
                events: {
                    'onReady': (e) => { if (initialStatus === 'playing') e.target.playVideo(); log(`ë¡œë“œ: [${title}]`); },
                    'onStateChange': (e) => { if (e.data === YT.PlayerState.ENDED && currentActiveData[vid].loop) e.target.playVideo(); }
                }
            });
        }

        function updateAllProgress() {
            if (!isHost) return;
            Object.keys(players).forEach(vid => {
                const p = players[vid];
                if (p.getPlayerState) {
                    const bar = document.getElementById(`bar-${vid}`);
                    const timeDisp = document.getElementById(`time-${vid}`);
                    if (bar && timeDisp) {
                        const cur = p.getCurrentTime(); const tot = p.getDuration();
                        bar.max = tot; bar.value = cur;
                        const per = tot > 0 ? (cur / tot) * 100 : 0;
                        bar.style.setProperty('--p', per + '%');
                        timeDisp.innerText = `${formatTime(cur)} / ${tot > 0 ? formatTime(tot) : "0:00"}`;
                    }
                }
            });
        }

        function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }

        async function addToPlaylist() {
            const url = document.getElementById('yt-url').value;
            const vid = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
            if (!vid) return alert("URL í™•ì¸");
            let title = document.getElementById('custom-title').value, ot = "ì •ë³´ ì—†ìŒ";
            try { const res = await fetch(`https://noembed.com/embed?url=${url}`); const data = await res.json(); ot = data.title || "BGM"; if (!title) title = ot; } catch (e) { title = title || "BGM"; }
            playlist.push({ id: vid, title: title, originalTitle: ot, url: url, loop: document.getElementById('is-loop').checked, volume: 100 });
            render(); document.getElementById('yt-url').value = ""; document.getElementById('custom-title').value = "";
        }

        // [í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ UI] ë³¼ë¥¨ ë°”, ë§í¬ ì•„ì´ì½˜, ìˆ˜ì • ë²„íŠ¼ ë³µêµ¬
        function render() {
            const container = document.getElementById('playlist-container'); container.innerHTML = '';
            playlist.forEach((item, i) => {
                const isActive = !!players[item.id];
                const div = document.createElement('div'); div.className = 'playlist-item'; div.draggable = isHost;
                div.innerHTML = `
                    <div class="item-main">
                        <span style="font-weight:bold; font-size:0.85rem;">${item.title} ${isActive ? '<span style="color:var(--accent); font-size:0.7rem;">[ON]</span>' : ''}</span>
                        <div class="btn-group">
                            ${isHost ? `
                                <div class="slider-group" style="display:flex; align-items:center; gap:5px; margin-right:8px;">
                                    <input type="range" min="0" max="100" value="${item.volume}" disabled class="fill-cyan" style="--p:${item.volume}%; width:50px; height:4px;">
                                    <span class="vol-text" style="font-size:0.6rem; text-decoration:none;" onclick="openVolModal('playlist', null, ${i})">${item.volume}%</span>
                                </div>
                                <button class="small-btn ${item.loop?'btn-loop-on':'btn-loop-off'}" onclick="playlist[${i}].loop=!playlist[${i}].loop; render();">${item.loop?'ë°˜ë³µ':'1íšŒ'}</button>
                                <button class="small-btn ${isActive ? 'btn-stop-toggle' : 'btn-play-toggle'}" onclick="${isActive ? `db.ref('rooms/${roomId}/active/${item.id}').remove()` : `db.ref('rooms/${roomId}/active/${item.id}').set({title:'${item.title}', status:'playing', loop:${item.loop}, volume:${item.volume}})`}">${isActive ? 'STOP' : 'PLAY'}</button>
                                <button class="small-btn" style="background:#555" onclick="openEditModal(${i})">ìˆ˜ì •</button>
                                <button class="small-btn" onclick="playlist.splice(${i}, 1); render();" style="background:#b71c1c">X</button>
                            ` : ''}
                        </div>
                    </div>
                    ${isHost ? `<div class="item-meta">ğŸ”— <a href="${item.url}" target="_blank" style="color:#666; text-decoration:underline;">${item.url}</a><br>ğŸ“„ ì›ì œ: ${item.originalTitle}</div>` : ''}
                `;
                if (isHost) {
                    div.ondragstart = () => div.classList.add('dragging');
                    div.ondragend = () => { div.classList.remove('dragging'); saveOrder(); };
                }
                container.appendChild(div);
            });
            if (isHost) {
                container.ondragover = e => {
                    e.preventDefault();
                    const next = [...container.querySelectorAll('.playlist-item:not(.dragging)')].find(s => e.clientY <= s.getBoundingClientRect().top + s.offsetHeight / 2);
                    container.insertBefore(document.querySelector('.dragging'), next);
                };
            }
        }

        function saveOrder() {
            const titles = [...document.querySelectorAll('.playlist-item span:first-child')].map(el => el.innerText.split(' [ON]')[0].trim());
            playlist = titles.map(t => playlist.find(p => p.title === t)).filter(p => p);
        }
        function openEditModal(i) {
            editingIndex = i; document.getElementById('edit-title').value = playlist[i].title;
            document.getElementById('edit-url').value = playlist[i].url;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function saveEdit() {
            const nt = document.getElementById('edit-title').value, nu = document.getElementById('edit-url').value, nv = nu.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
            if (nt) playlist[editingIndex].title = nt; if (nv) { playlist[editingIndex].url = nu; playlist[editingIndex].id = nv; }
            render(); closeModal('edit-modal');
        }
        function closeModal(mId) { document.getElementById(mId).style.display = 'none'; }
        
        // ì´ˆê¸°í™” ëª¨ë‹¬ ë¡œì§
        function openResetModal() { document.getElementById('reset-modal').style.display = 'flex'; }
        function executeSoftReset() {
            db.ref(`rooms/${roomId}/active`).remove();
            playlist = []; render(); log("ğŸ§¹ ì‹œìŠ¤í…œ ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ.");
            closeModal('reset-modal');
        }

        function savePlaylist() {
            const fn = prompt("ì €ì¥ íŒŒì¼ëª…:", `playlist_${roomName}`); if (!fn) return;
            const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${fn}.json`; a.click();
        }
        function loadPlaylist(e) { const reader = new FileReader(); reader.onload = (ev) => { playlist = JSON.parse(ev.target.result); render(); }; reader.readAsText(e.target.files[0]); }
        function log(msg) { const area = document.getElementById('log-area'); if(area) { area.innerHTML += `<div>> ${msg}</div>`; area.scrollTop = area.scrollHeight; } }
        function onYouTubeIframeAPIReady() { console.log("Youtube API Ready."); }
    </script>
</body>
</html>
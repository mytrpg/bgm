<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG BGM from Youtube</title>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00ffff; --grey: #333; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 650px; display: none; }
        
        /* ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 340px; border: 1px solid var(--accent); box-sizing: border-box; }
        .modal-content input { width: 100% !important; margin-bottom: 12px; display: block; box-sizing: border-box; }
        
        /* [1] ì…ì¥ í™”ë©´ ë° ê³µì§€ì‚¬í•­ ë°•ìŠ¤ êµ¬ì„± */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; padding: 20px 0; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #333; text-align: center; width: 340px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .login-card h1 { margin-bottom: 20px; width: 100%; }
        .login-card input { margin-bottom: 10px; width: 100%; display: block; }
        .login-card button { width: 100%; padding: 12px; display: block; margin-top: 5px; }

        /* [1] ê³µì§€ì‚¬í•­ ì „ìš© ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .notice-card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #333; width: 340px; box-sizing: border-box; }
        .notice-title { color: var(--accent); font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .notice-content { font-size: 0.75rem; color: #bbb; line-height: 1.8; text-align: left; }

        #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 40000; display: none; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        /* ë ˆì´ì•„ì›ƒ ê·œê²© */
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .flex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
        
        /* [2] ì„¹ì…˜ ì œëª© ë§ˆì§„ í†µì¼ (ì—¬ë°± ë¬¸ì œ í•´ê²°) */
        h2, h3 { color: var(--primary); margin: 0; font-size: 1.05rem; font-weight: bold; margin-bottom: 12px; }
        .flex-header h2, .flex-header h3 { margin-bottom: 0; } /* flex-header ë‚´ë¶€ì¼ ë•ŒëŠ” ê°œë³„ ë§ˆì§„ ì œê±° */
        
        .section-title { color: #fff; text-shadow: 0 0 10px rgba(0,255,255,0.3); margin-top: 15px; margin-bottom: 12px; font-size: 0.9rem; font-weight: bold; }

        input, button { background: #2c2c2c; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }

        /* Master Volume ë””ìì¸ ìœ ì§€ */
        .guest-master-vol { background: #333; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .vol-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
        .vol-title { font-size: 1.05rem; font-weight: bold; color: var(--accent); white-space: nowrap; margin-bottom: 0; }
        .vol-desc { font-size: 0.65rem; color: #888; flex: 1; text-align: left; margin: 0; }
        
        #guest-master-slider {
            -webkit-appearance: none; width: 100%; height: 12px; border-radius: 6px; outline: none; margin-top: 5px;
            background: linear-gradient(to right, var(--accent) 0%, var(--accent) var(--p, 100%), #444 var(--p, 100%));
        }
        #guest-master-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 0; height: 0; background: transparent; border: none; box-shadow: none; cursor: pointer;
        }

        /* í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM */
        .active-track-item { background: #252525; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .active-title-line { font-weight: bold; color: var(--accent); font-size: 0.95rem; margin-bottom: 15px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .active-controls-line { display: flex; gap: 4px; align-items: center; width: 100%; }
        
        .btn-status { height: 28px; font-size: 0.65rem; background: var(--primary); color: #000; flex: 1; border-radius: 4px; padding: 0; margin: 0; min-width: 42px; }
        .btn-status.active { background: var(--accent) !important; font-weight: 800; }
        .btn-delete { background: #444; color: #fff; flex: 1.2 !important; height: 28px; }
        .btn-vol-lavender { background: var(--primary) !important; color: #000 !important; font-weight: bold; min-width: 80px !important; }

        .slider-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; width: 100%; pointer-events: none !important; }
        input[type="range"].progress-bar { -webkit-appearance: none; height: 6px; border-radius: 3px; outline: none; background: #222; border: 1px solid #333; flex: 1; pointer-events: none !important; }
        input[type="range"].progress-bar::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; background: var(--accent); border-radius: 50%; cursor: default; }
        .time-text { font-size: 0.65rem; color: #888; min-width: 80px; text-align: right; font-family: monospace; }

        /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ */
        .playlist-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; cursor: grab; user-select: none; }
        .item-main { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 4px; align-items: center; }
        .small-btn { height: 26px; font-size: 0.65rem; border-radius: 4px; width: 50px; text-align: center; margin: 0; flex-shrink: 0; }
        .btn-vol-large { width: 85px !important; } 
        .btn-play-toggle { width: 60px; } 
        .btn-play-toggle.on { background: var(--accent) !important; font-weight: 800; }
        .item-meta { font-size: 0.65rem; color: #777; margin-top: 8px; display: flex; align-items: center; gap: 8px; overflow: hidden; white-space: nowrap; }
        .meta-link { color: #777; text-decoration: none; font-family: monospace; flex-shrink: 0; font-size: 0.65rem; }
        .meta-title { color: #777; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 0.65rem; }

        /* ê³¡ ì¶”ê°€ ì˜ì—­ 3ì¤„ ê³ ì • */
        .host-panel-container { display: flex; flex-direction: column; gap: 8px; }
        .add-music-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .add-music-header-controls { display: flex; align-items: center; gap: 10px; }
        .loop-label-wrapper { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; cursor: pointer; color: #888; white-space: nowrap; }
        .header-btn { width: auto; padding: 4px 10px; font-size: 0.65rem; margin: 0; background: #444; height: 26px; }
        .input-full { width: 100% !important; display: block; margin: 0; }

        /* í•˜ë‹¨ í‘¸í„° */
        .footer { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px; margin-bottom: 20px; font-size: 0.6rem; }
        .footer-link { color: #888; text-decoration: underline; cursor: pointer; }
        .footer-contact { color: #444; }
        .host-only { display: none; }

        /* ë§ˆì¹¨í‘œ ë°•ë©¸ */
        #players-container { position: fixed; top: -100px; left: -100px; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="players-container"></div>

    <div id="edit-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--accent); margin-bottom:15px;">ì •ë³´ ìˆ˜ì •</h3><input type="text" id="edit-title" placeholder="ì œëª©"><input type="text" id="edit-url" placeholder="ìœ íŠœë¸Œ URL"><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('edit-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="saveEdit()" style="flex:1; background:var(--accent); color:#000;">ì €ì¥</button></div></div></div>
    <div id="vol-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--accent); margin-bottom:15px;">ë³¼ë¥¨ ì„¤ì •</h3><p id="vol-modal-target" style="font-size:0.75rem; color:#888; margin-bottom:10px;"></p><input type="number" id="vol-input-box" min="0" max="100"><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('vol-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="saveVolumeFromModal()" style="flex:1; background:var(--accent); color:#000;">ì ìš©</button></div></div></div>
    <div id="reset-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:var(--primary); margin-bottom:15px;">ë°© ë°ì´í„° ì´ˆê¸°í™”</h3><p style="font-size:0.8rem; color:#bbb; line-height:1.6;">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ëª¨ë“  ê³¡ì„ ì¤‘ë‹¨í•˜ê³  ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="closeModal('reset-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button onclick="executeSoftReset()" style="flex:1; background:#b71c1c; color:#fff;">ì´ˆê¸°í™” ì‹¤í–‰</button></div></div></div>
    <div id="delete-modal" class="modal-overlay"><div class="modal-content"><h3 style="color:#b71c1c; margin-bottom:15px;">ê³¡ ì‚­ì œ í™•ì¸</h3><p id="delete-target-name" style="font-size:0.75rem; color:#888; margin-bottom:20px;"></p><div style="display:flex; gap:8px;"><button onclick="closeModal('delete-modal')" style="background:#444; flex:1;">ì·¨ì†Œ</button><button id="confirm-delete-btn" style="flex:1; background:#b71c1c; color:#fff;">ì‚­ì œ</button></div></div></div>

    <div id="login-screen">
        <div class="login-card">
            <h1 id="login-title" style="color:var(--accent); font-size: 1rem; margin-bottom: 20px;">TRPG BGM from Youtube</h1>
            <input type="text" id="input-room-name" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="input-nickname" placeholder="ë‹‰ë„¤ì„">
            <button id="btn-host-login" onclick="enterRoom('host')" style="background:var(--primary); color:#000;">ë°© ìƒì„± (í˜¸ìŠ¤íŠ¸)</button>
            <button id="btn-guest-login" onclick="enterRoom('guest')" style="background:var(--accent); color:#000; display:none;">ì…ì¥</button>
            <div id="guest-msg" style="display:none; margin-top:15px; font-size:0.8rem; color:#888;">ë§í¬ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì…ì¥í•˜ì„¸ìš”.</div>
        </div>

        <div class="notice-card">
            <div class="notice-title">ê³µì§€ì‚¬í•­ ë° ì—…ë°ì´íŠ¸</div>
            <div class="notice-content">
                â€¢ 2026-02-19: ì‹œìŠ¤í…œ ë¡œê·¸ ê°„ê²© ì¡°ì • ë° ê³µì§€ ë°•ìŠ¤ ì¶”ê°€<br>
                â€¢ 2026-02-18: ëª¨ë°”ì¼ ìµœì í™” ë° ì¬ìƒ ë°” ë™ê¸°í™” ê°œì„ <br>
                â€¢ í˜„ì¬ ë™ì‹œ ì ‘ì† 100ëª…ê¹Œì§€ ì•ˆì •ì ìœ¼ë¡œ ì§€ì›ë©ë‹ˆë‹¤.<br>
                â€¢ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ ì œë³´ëŠ” Twitter @SIHASTë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <div id="audio-unlock" onclick="unlockAudio()"><div style="font-size: 50px; margin-bottom: 20px;">ğŸ§</div><b>ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ í™œì„±í™”</b></div>

    <div class="container" id="main-container">
        <div class="guest-master-vol">
            <div class="vol-header">
                <span class="vol-title">My Master Volume</span>
                <p class="vol-desc" style="padding-left:10px;">* ë‚˜ì—ê²Œë§Œ ì ìš©ë˜ëŠ” ìŒëŸ‰ì…ë‹ˆë‹¤.</p>
                <span id="guest-vol-text" style="font-size:0.75rem; color:var(--accent); cursor:pointer; text-decoration:underline;" onclick="openVolModal('master')">100%</span>
            </div>
            <input type="range" id="guest-master-slider" min="0" max="100" value="100" oninput="changeMyMasterVolume(this.value)">
        </div>

        <div class="card">
            <div class="flex-header">
                <h2>ROOM: <span id="room-display"></span></h2>
                <button onclick="copyInviteLink()" style="width:auto; padding:5px 10px; font-size:0.65rem; background:#444;">ë§í¬ ë³µì‚¬</button>
            </div>
            <p class="section-title">í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM</p>
            <div id="active-tracks-ui"></div>
        </div>

        <div id="host-panel" class="host-only card">
            <div class="host-panel-container">
                <div class="add-music-header">
                    <h3>ê³¡ ì¶”ê°€</h3>
                    <div class="add-music-header-controls">
                        <label class="loop-label-wrapper"><input type="checkbox" id="is-loop" style="width:auto; margin:0; vertical-align:middle;"> ë°˜ë³µ</label>
                        <button onclick="addToPlaylist()" style="background:var(--accent); color:#000; width:60px; height:26px; padding:0;">ì¶”ê°€</button>
                    </div>
                </div>
                <input type="text" id="yt-url" class="input-full" placeholder="Youtube URL">
                <input type="text" id="custom-title" class="input-full" placeholder="í‘œì‹œ ì œëª©">
            </div>
        </div>

        <div class="card host-only" id="playlist-card">
            <div class="flex-header">
                <h3 id="playlist-header">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
                <div style="display:flex; gap:4px;">
                    <button class="header-btn" onclick="savePlaylistFile()">ì €ì¥</button>
                    <button class="header-btn" id="open-playlist-btn" onclick="document.getElementById('file-input').click()">ì—´ê¸°</button>
                    <button class="header-btn" style="background:#b71c1c;" onclick="openResetModal()">ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div id="playlist-container"></div>
            <input type="file" id="file-input" style="display:none" onchange="loadPlaylist(event)">
        </div>

        <div class="card">
            <h3>ì ‘ì†ì (<span id="user-count">0</span>)</h3>
            <div id="user-list-container"></div>
        </div>

        <div class="card">
            <h3>ì‹œìŠ¤í…œ ë¡œê·¸</h3>
            <div id="log-area">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
        </div>
        
        <div class="footer">
            <a href="https://docs.google.com/document/d/1P55lR81rj6nQOrX2bZPtJYCJ9ZzPpeJkBMeIbmwjils/edit?usp=sharing" target="_blank" class="footer-link">ì‚¬ìš©ì„¤ëª…ì„œ</a>
            <span class="footer-contact">ë¬¸ì˜: Twitter @SIHAST</span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCmuKgORZHasMoHTfldQdN8AEBYwR2uOQ0", authDomain: "trpg-bgm-from.firebaseapp.com", databaseURL: "https://trpg-bgm-from-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "trpg-bgm-from", storageBucket: "trpg-bgm-from.firebasestorage.app", messagingSenderId: "731757785916", appId: "1:731757785916:web:f02ee6e3d03f5e91856439" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let roomId = "", roomName = "", isHost = false, myNickname = "", myMasterVol = 100, playlist = [], players = {}, currentActiveData = {}, oldActiveData = {};

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('room')) {
                roomId = params.get('room');
                document.getElementById('input-room-name').style.display = 'none';
                document.getElementById('btn-host-login').style.display = 'none';
                document.getElementById('btn-guest-login').style.display = 'block';
                document.getElementById('guest-msg').style.display = 'block';
                if (params.get('h') === '1') { isHost = true; document.getElementById('login-title').innerText = "HOST LOGIN"; document.getElementById('btn-guest-login').innerText = "ê´€ë¦¬ì ì„¸ì…˜ ë³µêµ¬"; document.getElementById('btn-guest-login').style.background = "var(--primary)"; }
                else { document.getElementById('login-title').innerText = "GUEST LOGIN"; }
            }
        };

        async function enterRoom(role) {
            const nName = document.getElementById('input-nickname').value.trim();
            if (!nName) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myNickname = nName;
            if (role === 'host' && !roomId) { isHost = true; roomName = document.getElementById('input-room-name').value.trim() || "TRPG SESSION"; roomId = Math.random().toString(36).substring(2, 10); await db.ref(`rooms/${roomId}/roomName`).set(roomName); }
            else { const snap = await db.ref(`rooms/${roomId}`).once('value'); if (!snap.exists()) return alert("ë§Œë£Œëœ ë°©ì…ë‹ˆë‹¤."); roomName = snap.val().roomName || "GUEST ROOM"; isHost = (new URLSearchParams(window.location.search).get('h') === '1'); }
            if (isHost) window.history.replaceState({}, '', `?room=${roomId}&h=1`);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('audio-unlock').style.display = 'flex';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('room-display').innerText = roomName;
            changeMyMasterVolume(myMasterVol);
            if (isHost) {
                document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block');
                db.ref(`rooms/${roomId}/playlist`).on('value', (snap) => { playlist = snap.val() || []; render(); });
            }
            setupPresence(); initSync(); setInterval(updateAllProgress, 1000);
        }

        function copyInviteLink() { const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`; const t = document.createElement("textarea"); document.body.appendChild(t); t.value = link; t.select(); document.execCommand("copy"); document.body.removeChild(t); alert("ì´ˆëŒ€ ë§í¬ ë³µì‚¬ ì™„ë£Œ!"); }
        function setupPresence() { const usersRef = db.ref(`rooms/${roomId}/users`); const userRef = usersRef.push(); userRef.onDisconnect().remove(); usersRef.on('value', (snap) => { const users = snap.val() || {}; const userArray = Object.values(users); document.getElementById('user-count').innerText = userArray.length; const container = document.getElementById('user-list-container'); container.innerHTML = ''; userArray.forEach(u => { const tag = document.createElement('div'); tag.className = `user-tag ${u.isHost ? 'host' : ''}`; tag.innerText = `${u.isHost ? 'ğŸ‘‘ ' : ''}${u.nickname}`; container.appendChild(tag); }); }); userRef.set({ nickname: myNickname, isHost: isHost }); }
        function unlockAudio() { document.getElementById('audio-unlock').style.display = 'none'; log(`ì„¸ì…˜ ì ‘ì†: ${myNickname}`); }
        let vt = null, vv = null, vi = null;
        function openVolModal(type, vid = null, index = null) { vt = type; vv = vid; vi = index; const cur = type === 'master' ? myMasterVol : (type === 'active' ? currentActiveData[vid].volume : playlist[index].volume); document.getElementById('vol-modal-target').innerText = `ëŒ€ìƒ: ${type === 'master' ? 'ë§ˆìŠ¤í„°' : (type === 'active' ? currentActiveData[vid].title : playlist[index].title)}`; document.getElementById('vol-input-box').value = cur; document.getElementById('vol-modal').style.display = 'flex'; }
        async function saveVolumeFromModal() { const val = Math.max(0, Math.min(100, parseInt(document.getElementById('vol-input-box').value) || 0)); if (vt === 'master') changeMyMasterVolume(val); else if (vt === 'active') db.ref(`rooms/${roomId}/active/${vv}/volume`).set(val); else if (vt === 'playlist') { playlist[vi].volume = val; await db.ref(`rooms/${roomId}/playlist`).set(playlist); } closeModal('vol-modal'); }
        function changeMyMasterVolume(val) { myMasterVol = val; document.getElementById('guest-vol-text').innerText = `${val}%`; const slider = document.getElementById('guest-master-slider'); slider.value = val; slider.style.setProperty('--p', val + '%'); Object.keys(players).forEach(vid => { if (players[vid] && players[vid].setVolume) { const sVol = (currentActiveData[vid] && currentActiveData[vid].volume !== undefined) ? currentActiveData[vid].volume : 100; players[vid].setVolume((sVol * myMasterVol) / 100); } }); }
        function initSync() { db.ref(`rooms/${roomId}/active`).on('value', (snap) => { currentActiveData = snap.val() || {}; const activeIds = Object.keys(currentActiveData); const uiContainer = document.getElementById('active-tracks-ui'); uiContainer.innerHTML = activeIds.length === 0 ? '<p style="font-size: 0.75rem; color: #444;">ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ</p>' : ''; activeIds.forEach(vid => { const track = currentActiveData[vid]; const oldTrack = oldActiveData[vid]; if (!oldTrack) log(`BGM ì¬ìƒ: [${track.title}]`); else if (oldTrack.loop !== track.loop) log(`ë£¨í”„ ë³€ê²½: [${track.title}] -> ${track.loop ? 'ë°˜ë³µ' : '1íšŒ'}`); const div = document.createElement('div'); div.className = 'active-track-item'; const s = track.status, l = track.loop, vol = track.volume || 100; let controlsHTML = isHost ? `<div class="active-controls-line"><button class="btn-status btn-vol-lavender" onclick="openVolModal('active', '${vid}')">ë³¼ë¥¨: ${vol}%</button><button class="btn-status ${l ? 'active' : ''}" onclick="db.ref('rooms/${roomId}/active/${vid}/loop').set(${!l})">${l ? 'ë°˜ë³µ' : '1íšŒ'}</button><button class="btn-status ${s==='playing'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('playing')">ì¬ìƒ</button><button class="btn-status ${s==='paused'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('paused')">ì¼ì‹œì •ì§€</button><button class="btn-status ${s==='stopped'?'active':''}" onclick="db.ref('rooms/${roomId}/active/${vid}/status').set('stopped')">ì •ì§€</button><button class="btn-status btn-delete" onclick="db.ref('rooms/${roomId}/active/${vid}').remove()">ì§€ìš°ê¸°</button></div>` : ''; div.innerHTML = `<span class="active-title-line" title="${track.title}">${track.title}</span>${controlsHTML}<div class="slider-row"><input type="range" class="progress-bar" id="bar-${vid}" value="0" min="0" step="1" disabled><span class="time-text" id="time-${vid}">0:00 / 0:00</span></div>`; uiContainer.appendChild(div); if (!players[vid]) createPlayer(vid, track.loop, track.title, s); else if (players[vid].getPlayerState) { if (s === 'playing') players[vid].playVideo(); else if (s === 'paused') players[vid].pauseVideo(); else if (s === 'stopped') { players[vid].pauseVideo(); players[vid].seekTo(0); } players[vid].setVolume(((track.volume || 100) * myMasterVol) / 100); } }); Object.keys(players).forEach(vid => { if (!currentActiveData[vid]) { log(`BGM ì‚­ì œ: [${players[vid].title || vid}]`); players[vid].stopVideo(); players[vid].destroy(); delete players[vid]; } }); oldActiveData = JSON.parse(JSON.stringify(currentActiveData)); if (isHost) render(); }); }
        function createPlayer(vid, loop, title, initialStatus) { const div = document.createElement('div'); div.id = `player-${vid}`; document.getElementById('players-container').appendChild(div); players[vid] = new YT.Player(`player-${vid}`, { height: '1', width: '1', videoId: vid, playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1 }, events: { 'onReady': (e) => { players[vid].title = title; if (initialStatus === 'playing') e.target.playVideo(); }, 'onStateChange': (e) => { if (e.data === YT.PlayerState.ENDED && currentActiveData[vid].loop) e.target.playVideo(); } } }); }
        function updateAllProgress() { Object.keys(players).forEach(vid => { const p = players[vid]; if (p.getPlayerState && p.getPlayerState() !== -1) { const bar = document.getElementById(`bar-${vid}`); const timeDisp = document.getElementById(`time-${vid}`); const cur = p.getCurrentTime(); const tot = p.getDuration(); if (bar && timeDisp) { bar.max = tot; bar.value = cur; timeDisp.innerText = `${formatTime(cur)} / ${tot > 0 ? formatTime(tot) : "0:00"}`; } } }); }
        function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
        async function addToPlaylist() { const url = document.getElementById('yt-url').value; const vid = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1]; if (!vid) return alert("URL í™•ì¸"); let title = document.getElementById('custom-title').value, ot = "ì •ë³´ ì—†ìŒ"; try { const res = await fetch(`https://noembed.com/embed?url=${url}`); const data = await res.json(); ot = data.title || "BGM"; if (!title) title = ot; } catch (e) { title = title || "BGM"; } playlist.push({ id: vid, title: title, originalTitle: ot, url: url, loop: document.getElementById('is-loop').checked, volume: 100 }); await db.ref(`rooms/${roomId}/playlist`).set(playlist); document.getElementById('yt-url').value = ""; document.getElementById('custom-title').value = ""; }
        function render() { const container = document.getElementById('playlist-container'); container.innerHTML = ''; playlist.forEach((item, i) => { const isActive = currentActiveData && currentActiveData[item.id] !== undefined; const div = document.createElement('div'); div.className = 'playlist-item'; div.draggable = isHost; div.innerHTML = `<div class="item-main"><span style="font-weight:bold; font-size:0.85rem; pointer-events:none;">${item.title} ${isActive ? '<span style="color:var(--accent); font-size:0.7rem;">[ON]</span>' : ''}</span><div class="btn-group"><button class="small-btn btn-status btn-vol-large btn-vol-lavender" onclick="openVolModal('playlist', null, ${i})">ë³¼ë¥¨: ${item.volume}%</button><button class="small-btn btn-status ${item.loop?'active':''}" onclick="togglePlaylistLoop(${i})">${item.loop?'ë°˜ë³µ':'1íšŒ'}</button><button class="small-btn btn-status btn-play-toggle ${isActive?'on':''}" onclick="${isActive ? `db.ref('rooms/${roomId}/active/${item.id}').remove()` : `db.ref('rooms/${roomId}/active/${item.id}').set({title:'${item.title}', status:'playing', loop:${item.loop}, volume:${item.volume}})`}">${isActive ? 'STOP' : 'PLAY'}</button><button class="small-btn" style="background:#555" onclick="openEditModal(${i})">ìˆ˜ì •</button><button class="small-btn" onclick="openDeleteConfirm(${i})" style="background:#b71c1c; color:#fff;">X</button></div></div><div class="item-meta">ğŸ”— <a href="${item.url}" target="_blank" class="meta-link">${item.id}</a> <span class="meta-title">ì›ì œ: ${item.originalTitle}</span></div>`; if (isHost) { div.ondragstart = (e) => { div.classList.add('dragging'); e.dataTransfer.setData('text/plain', i); }; div.ondragend = () => { div.classList.remove('dragging'); saveOrder(); }; } container.appendChild(div); }); if (isHost) { container.ondragover = e => { e.preventDefault(); const dragging = document.querySelector('.dragging'); if (!dragging) return; const draggables = [...container.querySelectorAll('.playlist-item:not(.dragging)')]; const next = draggables.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (next == null) container.appendChild(dragging); else container.insertBefore(dragging, next); }; } }
        async function togglePlaylistLoop(i) { playlist[i].loop = !playlist[i].loop; await db.ref(`rooms/${roomId}/playlist`).set(playlist); }
        function openDeleteConfirm(i) { document.getElementById('delete-target-name').innerText = `ëŒ€ìƒ: ${playlist[i].title}`; document.getElementById('confirm-delete-btn').onclick = async () => { playlist.splice(i, 1); await db.ref(`rooms/${roomId}/playlist`).set(playlist); closeModal('delete-modal'); }; document.getElementById('delete-modal').style.display = 'flex'; }
        async function saveOrder() { const items = [...document.querySelectorAll('.playlist-item')]; const newOrder = []; items.forEach(el => { const title = el.querySelector('.item-main span').innerText.split(' [ON]')[0].trim(); const track = playlist.find(p => p.title === title); if (track) newOrder.push(track); }); playlist = newOrder; await db.ref(`rooms/${roomId}/playlist`).set(playlist); }
        function openEditModal(i) { editingIndex = i; document.getElementById('edit-title').value = playlist[i].title; document.getElementById('edit-url').value = playlist[i].url; document.getElementById('edit-modal').style.display = 'flex'; }
        async function saveEdit() { const nt = document.getElementById('edit-title').value, nu = document.getElementById('edit-url').value, nv = nu.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1]; if (nt) playlist[editingIndex].title = nt; if (nv) { playlist[editingIndex].url = nu; playlist[editingIndex].id = nv; } await db.ref(`rooms/${roomId}/playlist`).set(playlist); closeModal('edit-modal'); }
        function closeModal(mId) { document.getElementById(mId).style.display = 'none'; }
        function openResetModal() { document.getElementById('reset-modal').style.display = 'flex'; }
        async function executeSoftReset() { const rRef = db.ref(`rooms/${roomId}`); await rRef.child('playlist').set(null); await rRef.child('active').set(null); playlist = []; render(); document.querySelectorAll('.host-only').forEach(el => el.style.display = 'block'); log("ğŸ§¹ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ."); closeModal('reset-modal'); }
        function savePlaylistFile() { const fn = prompt("íŒŒì¼ëª…:", `playlist_${roomName}`); if (!fn) return; const blob = new Blob([JSON.stringify(playlist)], {type: "application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${fn}.json`; a.click(); }
        async function loadPlaylist(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (ev) => { try { playlist = JSON.parse(ev.target.result); await db.ref(`rooms/${roomId}/playlist`).set(playlist); e.target.value = ''; } catch(err) { alert("ìœ íš¨í•˜ì§€ ì•Šì€ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì¼ì…ë‹ˆë‹¤."); } }; reader.readAsText(file); }
        function log(msg) { const area = document.getElementById('log-area'); if(area) { area.innerHTML += `<div>> ${msg}</div>`; area.scrollTop = area.scrollHeight; } }
        function onYouTubeIframeAPIReady() { console.log("Youtube API Ready."); }
    </script>
</body>
</html>